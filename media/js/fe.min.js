var _mes=["","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];var base="";var base_ol="";var is_portal=false;var num_carga=20;var cargar_mas=0;var _cluster=true;var resetLimit=false;$(function(){if(window.location.hostname=="localhost"){base="/monitor";base_ol="/monitor"}else{base="http://"+window.location.hostname;base_ol=""}if(typeof portal!=="undefined"){is_portal=true}$("#loading").ajaxStart(function(){$("#loading").show()}).ajaxStop(function(){$("#loading").hide()});$("#lmh").click(function(){m({t:"Monitor - ColombisSSH",hid:"qlmh",w:600,h:400});return false});$(".cat").click(function(){$("div.filtro").hide();$(this).siblings("div.filtro").slideDown()});$(".btn_fcat").click(function(){setCatsHidden();addFeatures($(this).attr("class").split(" ")[0]);totalesxDepto();$(this).closest(".filtro").slideUp()});$(".btn_show_e").click(function(){var u=$(this).attr("class").split(" ");if(u[0]=="ec"){var v=map.getLayersByName("Emergencia Compleja")[0];$r_hide=$("#resumen_ec");$r_show=$("#resumen_dn")}else{var v=map.getLayersByName("Desastres Naturales")[0];$r_hide=$("#resumen_dn");$r_show=$("#resumen_ec")}if(v.getVisibility()){$(this).html("Mostrar eventos");v.setVisibility(false);$r_hide.hide();$r_show.removeClass("left half")}else{$(this).html("Ocultar eventos");v.setVisibility(true);$r_hide.show();$r_show.addClass("left half")}$(this).closest(".filtro").slideUp()});$(document).click(function(u){if(!$(u.target).closest(".cat, .filtro").length){$(".filtro").slideUp()}});var a=false;$(".tn_fcat").click(function(){$(this).closest(".filtro").find("input:checkbox").each(function(){$(this).attr("checked",a)});a=!a;return false});setCatsHidden();$("#minmax_total").toggle(function(){$(".ui-tabs-panel, #mapas_tipos").hide();$(this).removeClass("minimize");$(this).addClass("maximize")},function(){$(".ui-tabs-panel, #mapas_tipos").show();$(this).addClass("minimize");$(this).removeClass("maximize")});var h=false;$("#totalxd_all_chk").click(function(){$("#table_totalxd").find(":checkbox:not(:first)").each(function(){$(this).attr("checked",h)});h=!h});$("#filter_states").click(function(){addFeaturesFirstTime();totalesxDepto()});$("#download_incidents").click(function(){$("#loading").show();$.ajax({url:"download_incidents",success:function(){$("#loading").hide();location.href=base+"/export/xls/incidentes/Monitor-Incidentes"}})});$(".close").click(function(){$(this).closest(".filtro").slideUp()});$(".mapa_tipo:not(.active)").click(function(){var u=this;$.ajax({url:"mapa_tipo/"+$(u).data("tipo"),success:function(){$(".mapa_tipo").removeClass("activo");$(u).addClass("activo");addFeaturesFirstTime();totalesxDepto()}})});$("#group_fts").click(function(){$(this).toggleClass("group");$(".cat_color").toggle();_cluster=!_cluster;var u=(_cluster)?"Desagrupar":"Agrupar";$(this).find("h1").html(u+" mapa");addFeaturesFirstTime();totalesxDepto();$("#tabs").tabs("select",1)});$(".resumen_row","#resumen_ec").live("click",function(){$("#fcat_ec").find("input:checkbox").attr("checked",false);$("#fcat_ec").find("input:checkbox[value="+$(this).attr("id")+"]").attr("checked",true);setCatsHidden();addFeatures("ec");totalesxDepto()});$("#tabs").tabs();var l=2;var r=7;var q=new Date();var i=q.getFullYear();var o=q.getMonth();var t=q.getDate();var k=new Date(i,o,t,0,0).getTime();var f=new Date(k-daysToMiliseconds(r));var n=f.getDate();var g=f.getMonth();var p=f.getFullYear();var e=f.getTime();var b=new Date().getTime();$("#startDate").val(e/1000);$("#endDate").val(b/1000);markIniFin(n,g,p,t,o,i);setYear("ini",p);setYear("fin",i);$("#stime").change(function(){if($(this).val()!=0){var w=getStartEnd("ini");var u=getStartEnd("fin");var x=new Date(i,o,t,0,0);var z=x.getTime();switch($(this).val()){case"m":w=new Date(z-daysToMiliseconds(30));u=q;showGroupUngroup("show");break;case"s":w=new Date(z-daysToMiliseconds(7));u=q;showGroupUngroup("show");break;case"ay":w=new Date(z-daysToMiliseconds(1));u=q;showGroupUngroup("show");break;case"h":w=z;u=q;showGroupUngroup("show");break;default:w=new Date($(this).val(),0,1);u=new Date($(this).val(),11,31);showGroupUngroup("false");break}$("#startDate").val(w/1000);$("#endDate").val(u/1000);var v=w.getFullYear();var y=u.getFullYear();setYear("ini",v);setYear("fin",y);markIniFin(w.getDate(),w.getMonth(),v,u.getDate(),u.getMonth(),y);totalesxDepto();addFeaturesFirstTime();resetLimit=true;cargar_mas=0}});$("#aaaa div.v").click(function(){var u=parseInt($(this).find("div.a").text());$("#startDate").val(new Date(u,0,1,0,0,0,0).getTime()/1000);$("#endDate").val(new Date(u,11,31).getTime()/1000);addFeaturesFirstTime();setYear("ini",u);setYear("fin",u);$("#fin_text").val("31 de Diciembre");markIniFin(1,0,u,31,11,u);$("#time").hide();totalesxDepto()});var j=[[1,1]];$(".fecha").click(function(){$("div.filtro_fecha:not(#"+$(this).attr("dv")+")").hide();$("#"+$(this).attr("dv")).slideToggle()});$("div.filtro_fecha").each(function(){var u=this;$(this).find("li").click(function(){$(this).closest("div").find("li").removeClass("selected");$(this).addClass("selected");var z=$(this).attr("q");var B=$(this).attr("y");var A=$("#"+$(this).attr("q")+"_text");var w=$("#"+z+"_div");if(w.find("li.selected").length==3){var x=new Date($("li.selected[q=ini][y=yyyy]").attr("val"),$("li.selected[q=ini][y=mes]").attr("val")-1,$("li.selected[q=ini][y=dia]").attr("val")).getTime();var v=new Date($("li.selected[q=fin][y=yyyy]").attr("val"),$("li.selected[q=fin][y=mes]").attr("val")-1,$("li.selected[q=fin][y=dia]").attr("val")).getTime();if(x>v){alert("Desde debe ser menor que Hasta");A.val("");w.find("li").removeClass("selected");$("stime").val(0)}else{A.val($("li.selected[q="+z+"][y=dia]").text()+" de "+$("li.selected[q="+z+"][y=mes]").text()+" "+$("li.selected[q="+z+"][y=yyyy]").text());$("#startDate").val(x/1000);$("#endDate").val(v/1000);$("#stime").val(0)}}})});$("div.filtro_fecha").find(".close").click(function(){$("div.filtro_fecha").slideUp()});$("#lff").click(function(){var v=getStartEnd("ini");var u=getStartEnd("fin");if(v>u){alert("La fecha Desde debe ser menor que la fecha Hasta")}else{addFeaturesFirstTime();totalesxDepto()}return false});totalesxDepto();mapRender();var s=$("#table_totalxd");s.find(":checkbox").live("click",function(){if($(this).is(":checked")){$(this).closest("tr").removeClass("unselected")}else{$(this).closest("tr").addClass("unselected")}});s.find("tr:not(:first) td.n, tr:not(:last) td.n").live("click",function(){selDepto($(this).closest("tr").find("td.centroid").html())})});m=function(a){if($("#dialog").size()){$("#dialog").dialog("destroy")}else{$("body").append('<div id="dialog"></div>')}if(a.hid){$("#dialog").html($("#"+a.hid).html())}else{if(a.html){$("#dialog").html(a.html)}else{if(a.u){$("#dialog").load(a.u,function(f,e,b){if(e=="error"&&b.status==403){window.location.href="/"}})}}}sm(a)};sm=function(a){$("#dialog").dialog({height:(a.h?a.h:500),width:(a.w?a.w:900),modal:true,title:a.t,open:a.funOpen?a.funOpen:null,close:function(){$(this).dialog("destroy");$(this).remove()}})};listReportsEvents=function(){$(".report_list_map").each(function(){$(this).hover(function(){$(this).find(".opt").show()},function(){$(this).find(".opt").hide()})});$(this).find(".t").click(function(){$(this).parent("div").find(".hide").slideToggle()})};totalesxDepto=function(j){var h=getStartEnd("ini");var a=getStartEnd("fin");var b=$("#currentCatE").val()+"|"+$("#currentCatD").val();var g;var f;$("#loading_data").show();_states=getStatesChecked();if(is_portal){if(typeof j==="undefined"){$(".tab_data").html("")}var e;if(resetLimit){e=0}else{e=cargar_mas*num_carga}var i=["ec","dn"];if(e==0){$(".tab_data").html('<div>&nbsp;&nbsp;<img src="'+base+'/media/img/ajax-loader-mini.gif" />&nbsp;Cargando datos...</div>')}$.ajax({url:base+"/getIncidentesPortal/"+h+"/"+a+"/"+b+"/"+e+"/"+_states,dataType:"jsonp",beforeSend:function(){$("#loading").show()},success:function(s){f=s.t;num_e=s.t_e;num_d=s.t_d;g=s.e.length;$("#num_total_span").html(f);$("#num_total_ec_span").html(num_e);$("#num_total_dn_span").html(num_d);var p="";if(g>0){for(var r=0,q=g;r<q;r+=1){_js=s.e[r];_dt=_js.d.split(/\W+/);_date=[_dt[2],_mes[_dt[1]*1],_dt[0]].join(" ");p+='<div class="clear report_list_map report_list_map_'+_js.sys+'"> <div class="l '+_js.sys+'"> '+_js.sys.substring(0,1).toUpperCase()+'</div> <div class="t clear">'+_js.t+'</div> <div class="hide"><div class="date detail">'+_js.d+'</div> <div class="loc detail">'+_js.ln+' <span class="pdf opt"> <a href="http://sidih.colombiassh.org/sissh/download_pdf.php?c=2&id_depto='+_js.ld+'&id_mun=" target="_blank">Perfil '+_js.ldn+"</a></span></div> </<div></div>";p+='<div class="clear hide"><div class="left"><b>Categorias</b></div> <div class="opt right linko"><a href="http://www.colombiassh.org/gtmi/wiki/index.php/Sistema_de_categor%C3%ADas_del_m%C3%B3dulo_de_eventos_de_conflicto" target="_blank">Definici&oacute;n</a></div>';for(c in _js.c){p+='<div class="clear cat">&raquo;&nbsp;'+c;if(_js.c[c].length>0){p+=": "}for(d in _js.c[c]){if(d>0){p+=", "}p+=_js.c[c][d]}p+="</div>"}p+="</div>";p+='<div class="clear"></div> ';if(show.desc){p+='<div class="desc hide"><b>Descripci&oacute;n</b>: '+_js.desc+"</div> "}if(show.fuente){if(_js.f!=""){p+='<div class="f hide"><div class="ft">Fuente de noticia</div>';for(var o=0,n=_js.f.length;o<n;o+=1){p+='<div class="fc">';if(_js.f[o][0]!=""&&_js.f[o][1]!=""){p+='<div class="fct">'+_js.f[o][0]+" :: "+_js.f[o][1]+"</div>"}if(_js.f[o][3]!=""){p+='<div class="fcc"><b>Descripci\u00f3n tomada de la fuente</b>: "'+_js.f[o][3]+'"</div>'}if(_js.f[o][2].indexOf("http")!=-1){p+='<div class="fcc"><a href="'+_js.f[o][2]+'" target="_blank">'+_js.f[o][2]+"</a></div></div> "}}p+="</div>"}}p+="</div></div>"}if((e+num_carga)<f){p+='<div id="cargar_mas"><div class="btn cargar_mas">Cargar mas eventos</div></div>'}}else{p='<div class="no">No hay eventos registrados</div>'}$div=$("#incidentes");if(e==0){$div.html(p)}else{$div.find(".cargar_mas").remove();$div.append(p)}$(".cargar_mas").click(function(){cargar_mas+=1;totalesxDepto(true);return false});if(_states!=0){selDepto($("#state").attr("centroid"))}$("#loading").hide();resumenAfectacion(s);charts(s.charts);$("#loading_data").hide()}})}else{$("#table_totalxd tbody").html('<tr><td colspan="4"><img src="media/img/ajax-loader-mini.gif" />&nbsp;Actualizando datos...</td></tr>');$.ajax({url:base+"/totalxd/"+h+"/"+a+"/"+b+"/"+_states,dataType:"json",success:function(q){$("#table_totalxd tbody tr").remove();var p=q.t;var n;var o=true;var k=$("#table_totalxd tbody");var l=k.html();l+='<tr class="totalxd"><td></td><td class="left">Total</td><td class="ec">'+p.ec+'</td><td class="dn">'+p.dn+"</td></tr>";for(var r in q.r){_i=q.r[r];n=(_i.css=="")?"checked":"";if(o&&(_i.ec>0||_i.dn>0)){o=false}l+='<tr class="f '+_i.css+" "+_i.hide+'"><td><input type="checkbox" name="deptos[]" value="'+_i.state_id+'" '+n+' /></td><td class="n left">'+_i.d+'</td><td class="ec">'+_i.ec+'</td><td class="dn">'+_i.dn+'</td><td class="hide centroid">'+_i.c+"</td></tr>"}if(o){l+='<tr><td colspan="4"><br />No existen eventos</td></tr>'}k.html(l);resumenAfectacion(q);charts(q.charts);$("#loading_data").hide()}})}};resumenAfectacion=function(f){var b=(getMapaAfectacion()==1)?"personas afectadas":"eventos";var e=0;$("#resumen_ec, #resumen_dn").find(".resumen_row:not(:first)").remove();$resumen_ec=$("#resumen_ec");for(var g in f.rsms_ec){$div=$(".resumen_row:first").clone();$div.removeClass("hide");$div.addClass("ect");rsm=f.rsms_ec[g];$div.attr("id",rsm.cat_id);$div.find(".num").html(numberWithCommas(rsm.n));$div.find(".cat").html(rsm.t);$div.find(".cat_color").css("background-color","#"+rsm.c);e+=rsm.n*1;if(rsm.n>0){$resumen_ec.append($div)}}if(e>0){$("#resumen_total_ec_num").html(numberWithCommas(e));$resumen_ec.show()}$resumen_dn=$("#resumen_dn");var a=0;for(var g in f.rsms_dn){$div=$(".resumen_row:first").clone();$div.removeClass("hide");$div.addClass("dnt");rsm=f.rsms_dn[g];$div.find(".num").html(numberWithCommas(rsm.n));$div.find(".cat").html(rsm.t);a+=rsm.n*1;if(rsm.n>0){$resumen_dn.append($div)}}if(a>0){$("#resumen_total_dn_num").html(numberWithCommas(a));$resumen_dn.show()}if(e>0&&a>0){$("#resumen_ec, #resumen_dn").addClass("left half")}else{$("#resumen_ec, #resumen_dn").removeClass("left half")}$(".data_title").html(b)};charts=function(i){Highcharts.setOptions({chart:{style:{fontFamily:"Arial",fontSize:"11px"}}});var h={fontSize:"14px",margin:0};var g=i[0];$("#chart_1").highcharts({chart:{type:"line",width:350,height:250,style:{}},plotOptions:{series:{marker:{radius:3}}},title:{text:g.title,style:h},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e. %b",year:"%b"}},yAxis:g.yAxis,series:g.data});if(i[1]!=undefined){$("#charts_pie").show();var a=[30,30,10,30];var f=180;var e=350;var b={allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:true,distance:20,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>: {point.percentage:.1f} %"}};var g=i[1];$("#chart_2").highcharts({chart:{type:"pie",width:e,height:f,margin:a,style:{}},plotOptions:{pie:b},title:{text:g.title,style:h},series:[{data:g.data}]});var g=i[2];$("#chart_3").highcharts({chart:{type:"pie",width:e,height:f,margin:a,style:{}},plotOptions:{pie:b},title:{text:g.title,style:h},series:[{data:g.data}]})}else{$("#charts_pie").hide()}};forceSortTable=function(){var a=[[1,1]];$("#table_totalxd").trigger("update");$("#table_totalxd").trigger("sorton",[a])};setCatsHidden=function(){var a=[];$("#fcat_ec").find("input:checked").each(function(){a.push($(this).val())});$("#currentCatE").val(a);a=[];$("#fcat_dn").find("input:checked").each(function(){a.push($(this).val())});$("#currentCatD").val(a)};daysToMiliseconds=function(a){return a*24*3600*1000};getStartEnd=function(b){var a=[];a.ini=$("#startDate").val();a.fin=$("#endDate").val();return a[b]};getYear=function(a){return $("#yyyy_"+a).val()};setYear=function(g,f){$("#yyyy_"+g).val(f);var b=getStartEnd();var e=new Date(getStartEnd("ini")*1000);var a=new Date(getStartEnd("fin")*1000);$("#periodo_texto").html(e.getDate()+"-"+_mes[1+e.getMonth()]+" "+e.getFullYear()+" al "+a.getDate()+"-"+_mes[1+a.getMonth()]+" "+a.getFullYear())};markIniFin=function(i,b,a,e,g,f){var h="selected";b=b+1;g=g+1;$("#ini_fin").find("li").removeClass("selected");$("li[y=dia][q=ini][val="+i+"]").addClass(h);$("li[y=mes][q=ini][val="+b+"]").addClass(h);$("li[y=yyyy][q=ini][val="+a+"]").addClass(h);$("li[y=dia][q=fin][val="+e+"]").addClass(h);$("li[y=mes][q=fin][val="+g+"]").addClass(h);$("li[y=yyyy][q=fin][val="+f+"]").addClass(h);$("#ini_text").val(i+" de "+_mes[b]+" "+a);$("#fin_text").val(e+" de "+_mes[g]+" "+f)};getStatesChecked=function(){var a=[];$("#table_totalxd").find(":checked").each(function(){if($(this).val()!=0){a.push($(this).val())}});return a.join(",")};getMapaAfectacion=function(){return($(".mapa_tipo.activo").data("tipo")=="eventos")?0:1};showGroupUngroup=function(a){$btn=$("#group_fts");if(a=="show"){$btn.show()}else{$btn.hide()}};function numberWithCommas(b){var a=b.toString().split(".");return a[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(a[1]?"."+a[1]:"")}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};