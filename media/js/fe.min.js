var _mes=["","Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];var base="";var base_ol="";var is_portal=false;var layout;var num_carga=20;var cargar_mas=0;var _cluster=true;var resetLimit=false;var acceso=false;var _year,_month,_day,_today;var ocultar="";$(function(){_today=new Date();_year=_today.getFullYear();_month=_today.getMonth();_day=_today.getDate();var k=2;var n=7;var i=new Date(_year,_month,_day,0,0).getTime();var e=new Date(i-daysToMiliseconds(n));var l=e.getDate();var g=e.getMonth();var o=e.getFullYear();var f=e.getTime();var b=new Date().getTime();$("#startDate").val(f/1000);$("#endDate").val(b/1000);markIniFin(l,g,o,_day,_month,_year);setYear("ini",o);setYear("fin",_year);if(window.location.hostname=="localhost"||window.location.hostname=="190.66.6.168"){base="/monitor";base_ol="/monitor"}else{base="http://"+window.location.hostname;base_ol=""}if(typeof portal!=="undefined"){is_portal=true}if(typeof layout==="undefined"){layout="monitor"}set100Height();$(window).resize(function(){set100Height()});$(document).ajaxStart(function(){$("#loading").show()});$(document).ajaxStop(function(){$("#loading").hide()});$("#lmh").click(function(){m({t:"Monitor - ColombisSSH",hid:"qlmh",w:600,h:400});return false});$menu_li=$("#menu").find("li.sub");$menu_li.click(function(){$(".filtro").fadeOut(100);var q=$("#"+$(this).data("div"));var r=100*q.data("index")+"px";q.css("top",r);q.fadeIn(100);$menu_li.removeClass("menu_activo");$(this).addClass("menu_activo")});if(layout=="monitor"){$("input").iCheck({checkboxClass:"icheckbox_square-orange",radioClass:"iradio_square-orange"});$(".btn_fcat").click(function(){setCatsHidden();var q=$(this).attr("class").split(" ")[0];acceso=false;if(q=="acceso"){$("#btn_show_dn").html("Mostrar eventos");acceso=true}addFeatures(q);totalesxDepto();$(this).closest(".filtro").hide()});$(".btn_show_e").click(function(){var q=$(this).attr("class").split(" ");ocultarViolenciaDesastres(q[0]);$(this).closest(".filtro").hide()});var a=false;$(".tn_fcat").click(function(){$(this).closest(".filtro").find("input:checkbox").each(function(){$(this).iCheck("toggle");$(this).attr("checked",a)});a=!a;return false});$("#minmax_total").toggle(function(){$(".ui-tabs-panel").hide();$(this).removeClass("minimize");$(this).addClass("maximize")},function(){$(".ui-tabs-panel").show();$(this).addClass("minimize");$(this).removeClass("maximize")});var h=false;$("#totalxd_all_chk").click(function(){$("#table_totalxd").find(":checkbox:not(:first)").each(function(){$(this).attr("checked",h)});h=!h});$("#filter_states").click(function(){addFeaturesFirstTime();totalesxDepto()});$("#download_incidents").click(function(){$("#loading").show();$.ajax({url:"download_incidents",success:function(){$("#loading").hide();location.href=base+"/export/xls/incidentes/Monitor-Incidentes"}})});$("a.close").click(function(){$(this).closest(".filtro").hide();$('li[data-div="'+$(this).attr("data-div")+'"]').removeClass("menu_activo")});$(".filtro_fecha").find("div.close").click(function(){$(this).closest(".filtro_fecha").hide()});$("input[name=rap]").on("ifClicked",function(q){applyPeriod($(this).val())})}$(".mapa_tipo:not(.active)").click(function(){var q=this;$.ajax({url:"session_var/mapa_tipo/"+$(q).data("tipo"),success:function(){$(".mapa_tipo").removeClass("menu_activo");$(q).addClass("menu_activo");addFeaturesFirstTime();totalesxDepto()}})});$("#group_fts").click(function(){$(".cat_color").toggle();_cluster=!_cluster;var q=(_cluster)?"Desagrupado":"Agrupado";$(this).find("span").html(q);addFeaturesFirstTime();totalesxDepto();$("#tabs").tabs("select",1)});$("#layers").click(function(){$("#layers_div").toggle()});$("#layers_div").on("ifClicked",":checkbox",function(r){var t=$(this);var s=t.closest("li");var q=true;if(t.is(":checked")){q=false;s.removeClass("selected")}else{s.addClass("selected")}addWMSLayer(t.val(),t.val(),q)});if(layout!="monitor"){$("#stime").change(function(){applyPeriod($(this).val());addFeatures();totalesxDepto()})}$(".resumen_row","#resumen_ec").live("click",function(){$("#fcat_ec").find("input:checkbox").attr("checked",false);$("#fcat_ec").find("input:checkbox[value="+$(this).attr("id")+"]").attr("checked",true);setCatsHidden();addFeatures("ec");totalesxDepto()});if(layout!="portal_home"){setCatsHidden();if($("#tabs").length>0){$("#tabs").tabs()}$(".fecha").click(function(){$("div.filtro_fecha:not(#"+$(this).attr("dv")+")").hide();$("#"+$(this).attr("dv")).slideToggle()});$("div.filtro_fecha").each(function(){var q=this;$(this).find("li").click(function(){$(this).closest("div").find("li").removeClass("selected");$(this).addClass("selected");var u=$(this).attr("q");var w=$(this).attr("y");var v=$("#"+$(this).attr("q")+"_text");var s=$("#"+u+"_div");if(s.find("li.selected").length==3){var t=new Date($("li.selected[q=ini][y=yyyy]").attr("val"),$("li.selected[q=ini][y=mes]").attr("val")-1,$("li.selected[q=ini][y=dia]").attr("val")).getTime();var r=new Date($("li.selected[q=fin][y=yyyy]").attr("val"),$("li.selected[q=fin][y=mes]").attr("val")-1,$("li.selected[q=fin][y=dia]").attr("val")).getTime();if(t>r){alert("Desde debe ser menor que Hasta");v.val("");s.find("li").removeClass("selected")}else{v.val($("li.selected[q="+u+"][y=dia]").text()+" de "+$("li.selected[q="+u+"][y=mes]").text()+" "+$("li.selected[q="+u+"][y=yyyy]").text());$("#startDate").val(t/1000);$("#endDate").val(r/1000)}}})});$("div.filtro_fecha").find(".close").click(function(){$("div.filtro_fecha").slideUp()});$("#lff").click(function(){var r=getStartEnd("ini");var q=getStartEnd("fin");if(r>q){alert("La fecha Desde debe ser menor que la fecha Hasta")}else{addFeaturesFirstTime();totalesxDepto()}return false})}totalesxDepto();mapRender();var p=$("#table_totalxd");p.find(":checkbox").live("click",function(){if($(this).is(":checked")){$(this).closest("tr").removeClass("unselected")}else{$(this).closest("tr").addClass("unselected")}});p.find("tr:not(:first) td.n, tr:not(:last) td.n").live("click",function(){selDepto($(this).closest("tr").find("td.centroid").html())});$.ajax({url:"geonode_layers.html",success:function(q){$ul=$("#layers_ul");$ul.append(q);$ul.append($ul.find("li").sort(function(s,r){aa=$(s).find("h3").text();bb=$(r).find("h3").text();return aa==bb?0:aa<bb?-1:1}));$ul.find("input").iCheck({checkboxClass:"icheckbox_square-orange",radioClass:"iradio_square-orange"})}});$("#layers_search").keyup(function(q){clearTimeout($.data(this,"timer"));if(q.keyCode==13){search(true)}else{$(this).data("timer",setTimeout(search,500))}})});function search(e){var f=$("#layers_search");var a=f.val();if(!e&&a.length<3){return}var b=$("#layers_ul li");b.each(function(){var h=new RegExp(a,"i");$(this).show();var g=h.exec($(this).html());if(g===null){$(this).hide()}});f.focusout(function(){b.fadeOut(100)})}function ocultarViolenciaDesastres(e){var b;if(e=="ec"){var f=map.getLayersByName("Emergencia Compleja")[0];$r_hide=$("#resumen_ec");$r_show=$("#resumen_dn")}else{var f=map.getLayersByName("Desastres Naturales")[0];$r_hide=$("#resumen_dn");$r_show=$("#resumen_ec");$eventos_desastres=$("#report_list_map_desastres")}if(f.getVisibility()){$(this).html("Mostrar eventos");f.setVisibility(false);b=false;$r_hide.hide();$r_show.removeClass("left half");$eventos_desastres.hide();ocultar=e}else{$(this).html("Ocultar eventos");f.setVisibility(true);b=true;$r_hide.show();$r_show.addClass("left half");$eventos_desastres.show();ocultar=""}var a=map.getLayersByName("Destacados")[0];a.setVisibility(!a.getVisibility());$("#chart_1").highcharts().get(e).setVisible(b,true)}function applyPeriod(h){if(h!=0){var e=getStartEnd("ini");var a=getStartEnd("fin");var f=new Date(_year,_month,_day,0,0);var i=f.getTime();switch(h){case"acum":e=new Date(_year,0,1);a=_today;showGroupUngroup("show");break;case"m":e=new Date(i-daysToMiliseconds(30));a=_today;showGroupUngroup("show");break;case"s":e=new Date(i-daysToMiliseconds(7));a=_today;showGroupUngroup("show");break;case"ay":e=new Date(i-daysToMiliseconds(1));a=_today;showGroupUngroup("show");break;case"h":e=new Date(i);a=_today;showGroupUngroup("show");break;default:e=new Date(h,0,1);a=new Date(h,11,31);showGroupUngroup("false");break}$("#startDate").val(e/1000);$("#endDate").val(a/1000);var b=e.getFullYear();var g=a.getFullYear();setYear("ini",b);setYear("fin",g);markIniFin(e.getDate(),e.getMonth(),b,a.getDate(),a.getMonth(),g);resetLimit=true;cargar_mas=0}}m=function(a){if($("#dialog").size()){$("#dialog").dialog("destroy")}else{$("body").append('<div id="dialog"></div>')}if(a.hid){$("#dialog").html($("#"+a.hid).html())}else{if(a.html){$("#dialog").html(a.html)}else{if(a.u){$("#dialog").load(a.u,function(f,e,b){if(e=="error"&&b.status==403){window.location.href="/"}})}}}sm(a)};sm=function(a){$("#dialog").dialog({height:(a.h?a.h:500),width:(a.w?a.w:900),modal:true,title:a.t,open:a.funOpen?a.funOpen:null,close:function(){$(this).dialog("destroy");$(this).remove()}})};listReportsEvents=function(){$(".report_list_map").each(function(){$(this).hover(function(){$(this).find(".opt").show()},function(){$(this).find(".opt").hide()})});$(this).find(".t").click(function(){$(this).parent("div").find(".hide").slideToggle()})};totalesxDepto=function(l){var f=getStartEnd("ini");var a=getStartEnd("fin");var n=$("#currentCatE").val()+"|"+$("#currentCatD").val();var h;var k;_states=getStatesChecked();if(layout=="portal_home"){$.ajax({url:base+"/getResumenPortalHome/"+f+"/"+a,dataType:"jsonp",success:function(q){for(j in q){$("#"+j).html(q[j]["t"]);$("#"+j+"_div").data("index",q[j]["v"])}var p=$("#resumen");p.append($("div.r").sort(function(s,r){return $(r).data("index")-$(s).data("index")}));for(j in q){if(q[j]["v"]==0){$("#"+j).html("--")}}}})}else{if(layout=="portal"){if(typeof l==="undefined"){$(".tab_data").html("")}var i;if(resetLimit){i=0}else{i=cargar_mas*num_carga}var g=["ec","dn"];if(i==0){$(".tab_data").html('<div>&nbsp;&nbsp;<img src="'+base+'/media/img/ajax-loader-mini.gif" />&nbsp;Cargando datos...</div>')}$.ajax({url:base+"/getIncidentesPortal/"+f+"/"+a+"/"+n+"/"+i+"/"+_states,dataType:"jsonp",beforeSend:function(){$("#loading").show()},success:function(u){k=u.t;num_e=u.t_e;num_d=u.t_d;h=u.e.length;$("#num_total_span").html(k);$("#num_total_ec_span").html(num_e);$("#num_total_dn_span").html(num_d);var r="";if(h>0){for(var t=0,s=h;t<s;t+=1){_js=u.e[t];_dt=_js.d.split(/\W+/);_date=[_dt[2],_mes[_dt[1]*1],_dt[0]].join(" ");r+='<div class="clear report_list_map report_list_map_'+_js.sys+'"> <div class="l '+_js.sys+'"> '+_js.sys.substring(0,1).toUpperCase()+'</div> <div class="t clear">'+_js.t+'</div> <div class="hide"><div class="date detail">'+_js.d+'</div> <div class="loc detail">'+_js.ln+' <span class="pdf opt"> <a href="http://sidih.salahumanitaria.co/sissh/download_pdf.php?c=2&id_depto='+_js.ld+'&id_mun=" target="_blank">Perfil '+_js.ldn+"</a></span></div> </<div></div>";r+='<div class="clear hide"><div class="left"><b>Categorias</b></div> <div class="opt right linko"><a href="http://www.salahumanitaria.co/gtmi/wiki/index.php/Sistema_de_categor%C3%ADas_del_m%C3%B3dulo_de_eventos_de_conflicto" target="_blank">Definici&oacute;n</a></div>';for(c in _js.c){r+='<div class="clear cat">&raquo;&nbsp;'+c;if(_js.c[c].length>0){r+=": "}for(d in _js.c[c]){if(d>0){r+=", "}r+=_js.c[c][d]}r+="</div>"}r+="</div>";r+='<div class="clear"></div> ';if(show.desc){r+='<div class="desc hide"><b>Descripci&oacute;n</b>: '+_js.desc+"</div> "}if(show.fuente){if(_js.f!=""){r+='<div class="f hide"><div class="ft">Fuente de noticia</div>';for(var q=0,p=_js.f.length;q<p;q+=1){r+='<div class="fc">';if(_js.f[q][0]!=""&&_js.f[q][1]!=""){r+='<div class="fct">'+_js.f[q][0]+" :: "+_js.f[q][1]+"</div>"}if(_js.f[q][3]!=""){r+='<div class="fcc"><b>Descripci\u00f3n tomada de la fuente</b>: "'+_js.f[q][3]+'"</div>'}if(_js.f[q][2].indexOf("http")!=-1){r+='<div class="fcc"><a href="'+_js.f[q][2]+'" target="_blank">'+_js.f[q][2]+"</a></div></div> "}}r+="</div>"}}r+="</div></div>"}if((i+num_carga)<k){r+='<div id="cargar_mas"><div class="btn cargar_mas">Cargar mas eventos</div></div>'}}else{r='<div class="no">No hay eventos registrados</div>'}$div=$("#incidentes");if(i==0){$div.html(r)}else{$div.find(".cargar_mas").remove();$div.append(r)}$(".cargar_mas").click(function(){cargar_mas+=1;totalesxDepto(true);return false});if(_states!=0){selDepto($("#state").attr("centroid"))}$("#loading").hide();resumenAfectacion(u);charts(u.charts);$("#loading_data").hide()}})}else{var e=(getMapaAfectacion()==1)?"v&iacute;ctimas":"eventos";if(acceso){e="restricción <br /> al acceso"}var b=$("#ini_text").val();var o=$("#fin_text").val();$("#titulo_general > #tgt").html("Mapa de "+e);$("#titulo_general > #tgc").html(b+" - "+o);$("#table_totalxd tbody").html('<tr><td colspan="4"><img src="media/img/ajax-loader-mini.gif" />&nbsp;Actualizando datos...</td></tr>');$.ajax({url:base+"/totalxd/"+f+"/"+a+"/"+n+"/"+_states,dataType:"json",success:function(u){$("#table_totalxd tbody tr").remove();var t=u.t;var r;var s=true;var p=$("#table_totalxd tbody");var q=p.html();q+='<tr class="totalxd"><td></td><td class="left">Total</td><td class="ec">'+t.ec+'</td><td class="dn">'+t.dn+"</td></tr>";for(var v in u.r){_i=u.r[v];r=(_i.css=="")?"checked":"";if(s&&(_i.ec>0||_i.dn>0)){s=false}q+='<tr class="f '+_i.css+" "+_i.hide+'"><td><input type="checkbox" name="deptos[]" value="'+_i.state_id+'" '+r+' /></td><td class="n left">'+_i.d+'</td><td class="ec">'+_i.ec+'</td><td class="dn">'+_i.dn+'</td><td class="hide centroid">'+_i.c+"</td></tr>"}if(s){q+='<tr><td colspan="4"><br />No existen eventos</td></tr>'}p.html(q);resumenAfectacion(u);charts(u.charts);$("#loading_data").hide()}})}}};resumenAfectacion=function(f){var b=(getMapaAfectacion()==1)?"personas afectadas":"eventos";var e=0;$("#resumen_ec, #resumen_dn").find(".resumen_row:not(:first)").remove();$resumen_ec=$("#resumen_ec");for(var g in f.rsms_ec){$div=$(".resumen_row:first").clone();$div.removeClass("hide");$div.addClass("ect");rsm=f.rsms_ec[g];$div.attr("id",rsm.cat_id);$div.find(".num").html(numberWithCommas(rsm.n));$div.find(".cat").html(rsm.t);$div.find(".cat_color").css("background-color","#"+rsm.c);if(rsm.n>0){$resumen_ec.append($div)}}e=f.t.ec;if(e>0){$("#resumen_total_ec_num").html(numberWithCommas(e));$resumen_ec.show()}$resumen_dn=$("#resumen_dn");var a=0;for(var g in f.rsms_dn){$div=$(".resumen_row:first").clone();$div.removeClass("hide");$div.addClass("dnt");rsm=f.rsms_dn[g];$div.find(".num").html(numberWithCommas(rsm.n));$div.find(".cat").html(rsm.t);if(rsm.n>0){$resumen_dn.append($div)}}a=f.t.dn;if(a>0){$("#resumen_total_dn_num").html(numberWithCommas(a));$resumen_dn.show()}if(e>0&&a>0){$("#resumen_ec, #resumen_dn").addClass("left half")}else{$("#resumen_ec, #resumen_dn").removeClass("left half")}$(".data_title").html(b);if(ocultar!=""){$r=$("#resumen_"+ocultar);$r.hide();if(ocultar=="ec"){$("#resumen_dn").removeClass("left half")}else{$("#resumen_ec").removeClass("left half")}}};charts=function(k){Highcharts.setOptions({chart:{style:{fontFamily:"Arial",fontSize:"11px"}},yAxis:{min:0}});var i={fontSize:"14px",margin:0};var h=k[0];$("#chart_1").highcharts({chart:{type:"line",width:350,height:250,style:{}},plotOptions:{series:{marker:{radius:3}}},title:{text:h.title,style:i},xAxis:{type:"datetime",dateTimeLabelFormats:{month:"%e. %b",year:"%b"},gridLineWidth:1,lineColor:"#000",tickColor:"#000"},yAxis:h.yAxis,series:h.data});if(k[1]!=undefined){$("#charts_pie").show();var a=[30,30,10,30];var g=180;var e=350;var b={allowPointSelect:true,cursor:"pointer",dataLabels:{enabled:true,distance:20,color:"#000000",connectorColor:"#000000",format:"<b>{point.name}</b>: {point.percentage:.1f} %"}};var f={stacking:"normal"};var h=k[1];$("#chart_2").highcharts({chart:{type:"pie",width:e,height:g,margin:a,style:{}},plotOptions:{pie:b},title:{text:h.title,style:i},series:[{data:h.data}]});var h=k[2];$("#chart_3").highcharts({chart:{type:"pie",width:e,height:g,margin:a,style:{}},plotOptions:{pie:b},title:{text:h.title,style:i},series:[{data:h.data}]})}else{$("#charts_pie").hide()}};forceSortTable=function(){var a=[[1,1]];$("#table_totalxd").trigger("update");$("#table_totalxd").trigger("sorton",[a])};setCatsHidden=function(){var a=[];$("#fcat_ec").find("input:checked").each(function(){a.push($(this).val())});$("#currentCatE").val(a);a=[];$("#fcat_dn").find("input:checked").each(function(){a.push($(this).val())});$("#currentCatD").val(a)};daysToMiliseconds=function(a){return a*24*3600*1000};getStartEnd=function(b){var a=[];a.ini=$("#startDate").val();a.fin=$("#endDate").val();return a[b]};getYear=function(a){return $("#yyyy_"+a).val()};setYear=function(g,f){$("#yyyy_"+g).val(f);var b=getStartEnd();var e=new Date(getStartEnd("ini")*1000);var a=new Date(getStartEnd("fin")*1000);$("#periodo_texto").html(e.getDate()+"-"+_mes[1+e.getMonth()]+" "+e.getFullYear()+" al "+a.getDate()+"-"+_mes[1+a.getMonth()]+" "+a.getFullYear())};markIniFin=function(i,b,a,e,g,f){var h="selected";b=b+1;g=g+1;$("#ini_fin").find("li").removeClass("selected");$("li[y=dia][q=ini][val="+i+"]").addClass(h);$("li[y=mes][q=ini][val="+b+"]").addClass(h);$("li[y=yyyy][q=ini][val="+a+"]").addClass(h);$("li[y=dia][q=fin][val="+e+"]").addClass(h);$("li[y=mes][q=fin][val="+g+"]").addClass(h);$("li[y=yyyy][q=fin][val="+f+"]").addClass(h);$("#ini_text").val(i+" de "+_mes[b]+" "+a);$("#fin_text").val(e+" de "+_mes[g]+" "+f)};getStatesChecked=function(){var a=[];$("#table_totalxd").find(":checked").each(function(){if($(this).val()!=0){a.push($(this).val())}});return a.join(",")};getMapaAfectacion=function(){return($(".mapa_tipo.menu_activo").data("tipo")=="eventos")?0:1};getAccesoCats=function(){var a=[];$("#fcat_list_acceso").find(":checked").each(function(){a.push($(this).val())});return a.join(",")};showGroupUngroup=function(a){$btn=$("#group_fts");if(a=="show"){$btn.show()}else{$btn.hide()}};function numberWithCommas(b){var a=b.toString().split(".");return a[0].replace(/\B(?=(\d{3})+(?!\d))/g,",")+(a[1]?"."+a[1]:"")}String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};set100Height=function(){$(".map_monitor, #menu").css("height",$(document).height())};setMapWidth=function(){$(".map_monitor").css("width",$(document).width())};