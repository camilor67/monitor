var map;var pL;var fromProjection;var toProjection;var features_ec;var features_dn;var markerRadius=5;var Style;var mtipo;var clear=true;var request=false;var filtro=id_filtro="";var nump_list=15;var id_depto="00";var rm_id_depto=false;var id_tema=id_org=0;var url_xd="/json/cluster/?m=0";var subdomain_ec="emergenciacompleja";var url_ec="http://www.colombiassh.org/"+subdomain_ec+""+url_xd;var subdomain_dn="inundaciones";var url_dn="http://"+subdomain_dn+".colombiassh.org"+url_xd;var markerOpacity=0.8;var selectCtrl;var l_ec,l_dn;var mapLoad=0;var _zoomOffset=6;var lym;var lytmp;var resolutions=[2445.9849047851562,1222.9924523925781,611.4962261962891,305.74811309814453,152.87405654907226,76.43702827453613,38.218514137268066,19.109257068634033,9.554628534317017,4.777314267158508,2.388657133579254,];var show=[];show.desc=false;show.fuente=true;var wms=[];wms=[{n:"Departamentos",u:"http://geonode.openstreetmap.co/geoserver/wms",l:"geonode:Depto_SIGOT",v:false,op:1},{n:"Municipios",u:"http://geonode.openstreetmap.co/geoserver/wms",l:"geonode:Municipios_SIGOT_84",v:false,op:1},];function selDepto(b){var a=b.split(",");map.setCenter(new OpenLayers.LonLat(a[0],a[1]),2)}function map(){if(is_portal){_zoomOffset=5;var b=[4891.9698095703125];resolutions=b.concat(resolutions)}fromProjection=new OpenLayers.Projection("EPSG:4326");toProjection=new OpenLayers.Projection("EPSG:900913");OpenLayers.ImgPath=base_ol+"/media/js/openlayers/img/";var f=new OpenLayers.Bounds(-8599122,-471155,-7441396,1505171);map=new OpenLayers.Map({div:"map",displayProjection:toProjection,theme:base_ol+"/media/js/openlayers/theme/default/style.min.css",maxExtent:f,eventListeners:{zoomend:mapMove},});var g=new OpenLayers.Layer.XYZ("OpenStreetMap",["http://otile1.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile2.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile3.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png","http://otile4.mqcdn.com/tiles/1.0.0/map/${z}/${x}/${y}.png"],{attribution:"<a href='http://www.mapquest.com/'  target='_blank'><img src='http://developer.mapquest.com/content/osm/mq_logo.png' border='0' /></a>, <a href='http://www.openstreetmap.org/' target='_blank'>OSM</a>",transitionEffect:"resize",zoomOffset:_zoomOffset,sphericalMercator:true,resolutions:resolutions});map.addLayer(g);var a;for(var e in wms){a=wms[e];lytmp=new OpenLayers.Layer.WMS(a.n,a.u,{layers:a.l,transparent:true,},{opacity:a.op,visibility:a.v});map.addLayer(lytmp)}map.setCenter(map.maxExtent.getCenterLonLat(),0);defStyle();addFeaturesFirstTime()}function addFeaturesFirstTime(){addFeatures();mapLoad=1}function addFeatures(i){if(i==undefined){i="ecdn"}var e=$("#startDate").val();var g=$("#endDate").val();var l=map.getZoom()+_zoomOffset;var a=map.getCenter();var k=[["s",e],["e",g],["z",l]];if(i=="ecdn"||i=="ec"){var j=k.concat([["c",$("#currentCatE").val()]]);if(map.getLayersByName("Emergencia Compleja").length>0){l_ec=map.getLayersByName("Emergencia Compleja")[0];l_ec.removeFeatures(l_ec.features)}else{l_ec=new OpenLayers.Layer.Vector("Emergencia Compleja",{styleMap:Styles});map.addLayer(l_ec)}var f=addURLParameter(url_ec,j);f=addURLParameter(f,[["states",getStatesChecked()]]);ajaxFeatures(f,l_ec)}if(i=="ecdn"||i=="dn"){var h=k.concat([["c",$("#currentCatD").val()]]);if(map.getLayersByName("Desastres Naturales").length>0){l_dn=map.getLayersByName("Desastres Naturales")[0];l_dn.removeFeatures(l_dn.features)}else{l_dn=new OpenLayers.Layer.Vector("Desastres Naturales",{styleMap:Styles});map.addLayer(l_dn)}var b=addURLParameter(url_dn,h);b=addURLParameter(b,[["states",getStatesChecked()]]);ajaxFeatures(b,l_dn)}selectCtrl=new OpenLayers.Control.SelectFeature([l_ec,l_dn],{clickout:true,onSelect:function(n){onFeatureSelect(n.attributes)}});map.addControl(selectCtrl);selectCtrl.activate()}function onFeatureSelect(e){var b="";var g=20;if(e.link.indexOf("index")>0){var f=e.link.replace("reports","monitor").replace("index","reports_list_map");var a;if(f.indexOf(subdomain_ec)>0){a=$("#currentCatE").val()}else{a=$("#currentCatD").val()}f+="&c="+a}else{var f=e.link.replace("reports","monitor").replace("view","single_report_map")}$.ajax({url:f,dataType:"jsonp",beforeSend:function(){$("#loading").show()},success:function(q){$("#loading").hide();for(var p=0,o=q.length;p<o;p+=1){_js=q[p];b+='<div class="report_list_map from_map"> <div class="t">'+_js.t+'</div> <div><div class="date detail">'+_js.d+'</div> <div class="loc detail">'+_js.ln+' <span class="pdf opt"> <a href="http://sidih.colombiassh.org/sissh/download_pdf.php?c=2&id_depto='+_js.ld+'&id_mun=" target="_blank">Consulte el perfil de '+_js.ldn+"</a></span></div> </<div></div>";b+='<div class="clear"><div class="left"><b>Categorias</b></div> <div class="opt right linko"><a href="http://www.colombiassh.org/gtmi/wiki/index.php/Sistema_de_categor%C3%ADas_del_m%C3%B3dulo_de_eventos_de_conflicto" target="_blank">Definici&oacute;n de categorias</a></div>';for(c in _js.c){b+='<div class="clear cat detail">'+c;if(_js.c[c].length>0){b+=": "}for(d in _js.c[c]){if(d>0){b+=", "}b+=_js.c[c][d]}b+="</div>"}b+="</div>";b+='<div class="clear"></div> ';if(show.desc){b+='<div class="desc hide"><b>Descripci&oacute;n</b>: '+_js.desc+"</div> "}if(show.fuente){if(_js.f!=""){b+='<div class="f hide"><div class="ft">Fuente de noticia</div>';for(var n=0,h=_js.f.length;n<h;n+=1){b+='<div class="fc">';if(_js.f[n][0]!=""&&_js.f[n][1]!=""){b+='<div class="fct">'+_js.f[n][0]+" :: "+_js.f[n][1]+"</div>"}if(_js.f[n][3]!=""){b+='<div class="fcc"><b>Descripci\u00f3n tomada de la fuente</b>: "'+_js.f[n][3]+'"</div>'}if(_js.f[n][2].indexOf("http")!=-1){b+='<div class="fcc"><a href="'+_js.f[n][2]+'" target="_blank">'+_js.f[n][2]+"</a></div></div> "}}b+="</div>"}}b+="</div></div>"}if(e.count>g){b+='<div id="mase"><div class="btn"><a href="'+e.link+'" target="_blank">Ir al listado completo de eventos</a></div></div>'}if(is_portal){$("#incidentes").html(b);$("#volver").show()}else{numr=(e.count>g)?g:e.count;m({t:"Monitor - ColombiaSSH :: Listado de eventos [ "+numr+" registros ]",html:b,w:800,h:500,funOpen:listReportsEvents,})}},})}function ajaxFeatures(e,a){var b=new OpenLayers.Format.GeoJSON({internalProjection:toProjection,externalProjection:fromProjection});$.ajax({url:e,dataType:"jsonp",success:function(f){var g=b.read(f);a.addFeatures(g);$("#loading").hide()},beforeSend:function(){$("#loading").show()}})}function mapMove(a){if(mapLoad>0){addFeatures();var b=true;var e=false;if(map.getZoom()>=3){b=false;e=true}}}function defStyle(){var a=new OpenLayers.Style({externalGraphic:"${icon}",graphicTitle:"${cluster_count}",pointRadius:"${radius}",fillColor:"${color}",fillOpacity:"${opacity}",strokeColor:"${strokeColor}",strokeWidth:4,strokeOpacity:"0.3",label:"${clusterCount}",title:"${clusterCount}",fontWeight:"${fontweight}",fontColor:"#ffffff",fontSize:"${fontsize}"},{context:{count:function(b){if(b.attributes.count<2){return 2*markerRadius}else{if(b.attributes.count==2){return(Math.min(b.attributes.count,7)+1)*(markerRadius*0.8)}else{return(Math.min(b.attributes.count,7)+1)*(markerRadius*0.6)}}},fontsize:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"9px"}else{feature_count=b.attributes.count;if(feature_count>1000){return"20px"}else{if(feature_count>500){return"18px"}else{if(feature_count>100){return"14px"}else{if(feature_count>10){return"12px"}else{if(feature_count>=2){return"10px"}else{return""}}}}}}},fontweight:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"normal"}else{return"bold"}},radius:function(b){feature_count=b.attributes.count;if(feature_count>1000){return markerRadius*7}else{if(feature_count>900){return markerRadius*6.8}else{if(feature_count>800){return markerRadius*6.6}else{if(feature_count>700){return markerRadius*6.4}else{if(feature_count>600){return markerRadius*6.2}else{if(feature_count>500){return markerRadius*6}else{if(feature_count>400){return markerRadius*5.7}else{if(feature_count>300){return markerRadius*5.2}else{if(feature_count>200){return markerRadius*4.7}else{if(feature_count>100){return markerRadius*4.2}else{if(feature_count>90){return markerRadius*4}else{if(feature_count>80){return markerRadius*3.8}else{if(feature_count>70){return markerRadius*3.6}else{if(feature_count>60){return markerRadius*3.4}else{if(feature_count>50){return markerRadius*3.2}else{if(feature_count>40){return markerRadius*3}else{if(feature_count>30){return markerRadius*2.8}else{if(feature_count>20){return markerRadius*2.6}else{if(feature_count>10){return markerRadius*2.4}else{return markerRadius*2}}}}}}}}}}}}}}}}}}}},strokeWidth:function(b){if(typeof(b.attributes.strokewidth)!="undefined"&&b.attributes.strokewidth!=""){return b.attributes.strokewidth}else{feature_count=b.attributes.count;if(feature_count>10000){return 18}else{if(feature_count>5000){return 16}else{if(feature_count>1000){return 14}else{if(feature_count>100){return 12}else{if(feature_count>10){return 10}else{if(feature_count>=2){return 5}else{return 1}}}}}}}},color:function(b){if(String(b.attributes.link).indexOf(subdomain_ec)==-1){return"#2ca02c"}else{return"#cc0000"}},strokeColor:function(b){if(String(b.attributes.link).indexOf(subdomain_ec)==-1){return"#2ca02c"}else{return"#cc0000"}},clusterCount:function(b){if(b.attributes.count>1){if($.browser.msie&&$.browser.version=="6.0"){return""}return b.attributes.count}else{return""}},opacity:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"1"}else{return markerOpacity}},labelalign:function(b){feature_icon=b.attributes.icon;if(feature_icon!==""){return"c"}else{return"c"}}}});Styles=new OpenLayers.StyleMap({"default":a,select:{fillColor:"#86ABD9",strokeColor:"#32a8a9"}})}function onFeatureUnselect(a){if(a.feature.popup!=null){map.removePopup(a.feature.popup);a.feature.popup.destroy();a.feature.popup=null}}function onPopupClose(a){selectCtrl.unselect(selectedFeature);selectedFeature=null};